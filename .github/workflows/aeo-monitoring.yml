name: AEO Monitoring and Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**/page.tsx'
      - 'lib/seo/**'
      - 'scripts/log-schema-validation.js'
      - 'scripts/sync-to-aeo-monitoring.js'
  pull_request:
    branches: [ main ]
    paths:
      - 'app/**/page.tsx'
      - 'lib/seo/**'
      - 'scripts/log-schema-validation.js'
      - 'scripts/sync-to-aeo-monitoring.js'
  schedule:
    # æ¯å¤©UTC 02:00è¿è¡Œ (åŒ—äº¬æ—¶é—´ 10:00)
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  validate-schemas:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Schema Validation
        id: validate-schema
        run: |
          echo "Running AEO schema validation..."

          # è¿è¡ŒéªŒè¯è„šæœ¬
          npm run aeo:validate

          # è¯»å–è¶‹åŠ¿æ•°æ®
          if [ -f "logs/schema-validation-trend.json" ]; then
            AVERAGE_SCORE=$(cat logs/schema-validation-trend.json | jq -r '.averageScore')
            TOTAL_PAGES=$(cat logs/schema-validation-trend.json | jq -r '.totalPages')
            PASS_RATE=$(echo "scale=1; $(cat logs/schema-validation-trend.json | jq -r '.passedPages') * 100 / $TOTAL_PAGES" | bc)

            echo "average_score=$AVERAGE_SCORE" >> $GITHUB_OUTPUT
            echo "total_pages=$TOTAL_PAGES" >> $GITHUB_OUTPUT
            echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT

            echo "## AEO éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
            echo "- å¹³å‡åˆ†æ•°: $AVERAGE_SCORE" >> $GITHUB_STEP_SUMMARY
            echo "- æ€»é¡µé¢æ•°: $TOTAL_PAGES" >> $GITHUB_STEP_SUMMARY
            echo "- é€šè¿‡ç‡: $PASS_RATE%" >> $GITHUB_STEP_SUMMARY
          else
            echo "average_score=0" >> $GITHUB_OUTPUT
            echo "total_pages=0" >> $GITHUB_OUTPUT
            echo "pass_rate=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate AEO Monitoring Report
        id: generate-report
        run: |
          echo "Generating AEO monitoring report..."
          npm run aeo:sync

          # æ£€æŸ¥æŠ¥å‘Šæ˜¯å¦ç”Ÿæˆ
          if [ -f "reports/AEO-Monitoring-Report.html" ]; then
            echo "report_path=reports/AEO-Monitoring-Report.html" >> $GITHUB_OUTPUT
          fi

      - name: Upload Validation Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aeo-validation-logs-${{ github.run_number }}
          path: |
            CI_WORKFLOW_VERIFICATION_REPORT.md
            logs/schema-validation.log
            logs/schema-validation-trend.json
          retention-days: 30

      - name: Upload AEO Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aeo-monitoring-report-${{ github.run_number }}
          path: reports/AEO-Monitoring-Report.html
          retention-days: 30

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // è¯»å–è¶‹åŠ¿æ•°æ®
            let trendData = null;
            if (fs.existsSync('logs/schema-validation-trend.json')) {
              trendData = JSON.parse(fs.readFileSync('logs/schema-validation-trend.json', 'utf8'));
            }

            if (trendData) {
              const { averageScore, totalPages, passedPages, warningPages, failedPages, commonIssues } = trendData;
              const passRate = totalPages > 0 ? (passedPages / totalPages * 100).toFixed(1) : '0';

              // æ„å»ºè¯„è®ºå†…å®¹
              let comment = '## ğŸ” AEO éªŒè¯æŠ¥å‘Š\n\n';
              comment += `### ğŸ“Š æ•´ä½“çŠ¶æ€\n`;
              comment += `- **å¹³å‡åˆ†æ•°**: ${averageScore.toFixed(1)}\n`;
              comment += `- **æ€»é¡µé¢æ•°**: ${totalPages}\n`;
              comment += `- **é€šè¿‡ç‡**: ${passRate}%\n\n`;

              comment += `### ğŸ“ˆ è¯¦ç»†ç»Ÿè®¡\n`;
              comment += `- âœ… **é€šè¿‡**: ${passedPages} é¡µé¢\n`;
              comment += `- âš ï¸ **è­¦å‘Š**: ${warningPages} é¡µé¢\n`;
              comment += `- âŒ **å¤±è´¥**: ${failedPages} é¡µé¢\n\n`;

              if (commonIssues && commonIssues.length > 0) {
                comment += `### ğŸ”§ å¸¸è§é—®é¢˜\n`;
                commonIssues.slice(0, 3).forEach((issue, index) => {
                  comment += `${index + 1}. **${issue.issue}** (${issue.count}æ¬¡)\n`;
                });
                comment += '\n';
              }

              // æ ¹æ®åˆ†æ•°æ·»åŠ å»ºè®®
              if (averageScore >= 95) {
                comment += 'ğŸ‰ **çŠ¶æ€**: ä¼˜ç§€ï¼AEO å®æ–½è´¨é‡å¾ˆé«˜ã€‚\n';
              } else if (averageScore >= 80) {
                comment += 'âš ï¸ **çŠ¶æ€**: è‰¯å¥½ï¼Œä½†æœ‰æ”¹è¿›ç©ºé—´ã€‚å»ºè®®å…³æ³¨å¸¸è§é—®é¢˜ã€‚\n';
              } else {
                comment += 'âŒ **çŠ¶æ€**: éœ€è¦æ”¹è¿›ã€‚è¯·ä¼˜å…ˆä¿®å¤é«˜é¢‘ç‡é—®é¢˜ã€‚\n';
              }

              comment += '\n---\n';
              comment += '*æ­¤è¯„è®ºç”± AEO ç›‘æ§ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*';

              // åˆ›å»ºæˆ–æ›´æ–°è¯„è®º
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Set Status Badge
        run: |
          # æ ¹æ®å¹³å‡åˆ†æ•°è®¾ç½®çŠ¶æ€
          AVERAGE_SCORE="${{ steps.validate-schema.outputs.average_score }}"
          STATUS_COLOR="red"
          STATUS_TEXT="Failed"

          if (( $(echo "$AVERAGE_SCORE >= 95" | bc -l) )); then
            STATUS_COLOR="brightgreen"
            STATUS_TEXT="Excellent"
          elif (( $(echo "$AVERAGE_SCORE >= 80" | bc -l) )); then
            STATUS_COLOR="orange"
            STATUS_TEXT="Good"
          elif (( $(echo "$AVERAGE_SCORE >= 0" | bc -l) )); then
            STATUS_COLOR="red"
            STATUS_TEXT="Needs Work"
          fi

          # åˆ›å»ºçŠ¶æ€å¾½ç« 
          echo "AEO validation status: $STATUS_TEXT (${AVERAGE_SCORE} points)"
          echo "::notice::AEO validation status: $STATUS_TEXT (${AVERAGE_SCORE} points)"
