import { generateToolStructuredData } from "@/lib/seo/tool-structured-data";
import { generateArticleStructuredData } from "@/lib/seo/article-structured-data";
import { generateBreadcrumbStructuredData } from "@/lib/seo/breadcrumb-structured-data";
import { generateHreflangConfig } from "@/lib/seo/multilingual-seo";

// ç»“æ„åŒ–æ•°æ®éªŒè¯å·¥å…·
export class StructuredDataValidator {
  private baseUrl =
    process.env.NEXT_PUBLIC_BASE_URL || "https://www.periodhub.health";

  // éªŒè¯å·¥å…·é¡µé¢ç»“æ„åŒ–æ•°æ®
  async validateToolPage(locale: string, toolSlug: string) {
    console.log(`ğŸ” éªŒè¯å·¥å…·é¡µé¢: ${locale}/interactive-tools/${toolSlug}`);

    try {
      const toolData = await generateToolStructuredData({
        locale,
        toolSlug,
        toolName: locale === "zh" ? "ç—‡çŠ¶è¯„ä¼°å·¥å…·" : "Symptom Assessment Tool",
        description:
          locale === "zh"
            ? "ä¸“ä¸šçš„æœˆç»ç—‡çŠ¶è¯„ä¼°å·¥å…·"
            : "Professional menstrual symptom assessment tool",
        features: [
          locale === "zh" ? "ç—‡çŠ¶è¯„ä¼°" : "Symptom Assessment",
          locale === "zh" ? "ä¸ªæ€§åŒ–å»ºè®®" : "Personalized Recommendations",
          locale === "zh" ? "å¥åº·æŠ¥å‘Š" : "Health Reports",
        ],
        category: "HealthApplication",
        rating: { value: 4.8, count: 1250 },
        breadcrumbs: [
          {
            name: locale === "zh" ? "äº’åŠ¨å·¥å…·" : "Interactive Tools",
            url: `${this.baseUrl}/${locale}/interactive-tools`,
          },
          {
            name: locale === "zh" ? "ç—‡çŠ¶è¯„ä¼°å·¥å…·" : "Symptom Assessment Tool",
            url: `${this.baseUrl}/${locale}/interactive-tools/${toolSlug}`,
          },
        ],
      });

      // éªŒè¯å¿…éœ€å­—æ®µ
      const requiredFields = ["@context", "@graph"];
      const missingFields = requiredFields.filter((field) => !toolData[field]);

      if (missingFields.length === 0) {
        console.log("âœ… å·¥å…·é¡µé¢ç»“æ„åŒ–æ•°æ®éªŒè¯é€šè¿‡");
        console.log(
          "ğŸ“Š åŒ…å«çš„Schemaç±»å‹:",
          toolData["@graph"]?.map((item: any) => item["@type"]),
        );
        return { success: true, data: toolData };
      } else {
        console.log("âŒ ç¼ºå°‘å¿…éœ€å­—æ®µ:", missingFields);
        return {
          success: false,
          error: `Missing fields: ${missingFields.join(", ")}`,
        };
      }
    } catch (error) {
      console.log("âŒ å·¥å…·é¡µé¢éªŒè¯å¤±è´¥:", error);
      return { success: false, error };
    }
  }

  // éªŒè¯æ–‡ç« é¡µé¢ç»“æ„åŒ–æ•°æ®
  async validateArticlePage(locale: string, slug: string) {
    console.log(`ğŸ” éªŒè¯æ–‡ç« é¡µé¢: ${locale}/articles/${slug}`);

    try {
      const articleData = await generateArticleStructuredData({
        locale: locale as "en" | "zh",
        slug,
        title: locale === "zh" ? "ç—›ç»ç¼“è§£æ–¹æ³•" : "Period Pain Relief Methods",
        description:
          locale === "zh"
            ? "ä¸“ä¸šçš„ç—›ç»ç¼“è§£æŒ‡å¯¼"
            : "Professional period pain relief guidance",
        author: "PeriodHub Health Team",
        datePublished: "2025-01-01",
        dateModified: "2025-01-01",
        image: `${this.baseUrl}/images/article-image.jpg`,
        breadcrumbs: [
          {
            name: locale === "zh" ? "æ–‡ç« ä¸­å¿ƒ" : "Articles",
            url: `${this.baseUrl}/${locale}/downloads`,
          },
          {
            name:
              locale === "zh" ? "ç—›ç»ç¼“è§£æ–¹æ³•" : "Period Pain Relief Methods",
            url: `${this.baseUrl}/${locale}/articles/${slug}`,
          },
        ],
      });

      // éªŒè¯å¿…éœ€å­—æ®µ
      const requiredFields = ["@context", "@graph"];
      const missingFields = requiredFields.filter(
        (field) => !articleData[field],
      );

      if (missingFields.length === 0) {
        console.log("âœ… æ–‡ç« é¡µé¢ç»“æ„åŒ–æ•°æ®éªŒè¯é€šè¿‡");
        console.log(
          "ğŸ“Š åŒ…å«çš„Schemaç±»å‹:",
          articleData["@graph"]?.map((item: any) => item["@type"]),
        );
        return { success: true, data: articleData };
      } else {
        console.log("âŒ ç¼ºå°‘å¿…éœ€å­—æ®µ:", missingFields);
        return {
          success: false,
          error: `Missing fields: ${missingFields.join(", ")}`,
        };
      }
    } catch (error) {
      console.log("âŒ æ–‡ç« é¡µé¢éªŒè¯å¤±è´¥:", error);
      return { success: false, error };
    }
  }

  // éªŒè¯hreflangé…ç½®
  async validateHreflangConfig(locale: string, path: string) {
    console.log(`ğŸ” éªŒè¯hreflangé…ç½®: ${locale}${path}`);

    try {
      const hreflangUrls = await generateHreflangConfig({
        locale,
        path,
        includeXDefault: true,
      });

      // éªŒè¯å¿…éœ€çš„è¯­è¨€æ ‡ç­¾
      const requiredLanguages = ["zh-CN", "en-US", "x-default"];
      const missingLanguages = requiredLanguages.filter(
        (lang) => !hreflangUrls[lang],
      );

      if (missingLanguages.length === 0) {
        console.log("âœ… hreflangé…ç½®éªŒè¯é€šè¿‡");
        console.log("ğŸŒ æ”¯æŒçš„è¯­è¨€:", Object.keys(hreflangUrls));
        return { success: true, data: hreflangUrls };
      } else {
        console.log("âŒ ç¼ºå°‘è¯­è¨€æ ‡ç­¾:", missingLanguages);
        return {
          success: false,
          error: `Missing languages: ${missingLanguages.join(", ")}`,
        };
      }
    } catch (error) {
      console.log("âŒ hreflangéªŒè¯å¤±è´¥:", error);
      return { success: false, error };
    }
  }

  // ç”ŸæˆGoogle Rich Results Test URL
  generateRichResultsTestUrl(pageUrl: string) {
    const encodedUrl = encodeURIComponent(pageUrl);
    return `https://search.google.com/test/rich-results?url=${encodedUrl}`;
  }

  // ç”Ÿæˆå®Œæ•´çš„éªŒè¯æŠ¥å‘Š
  async generateValidationReport() {
    console.log("ğŸš€ å¼€å§‹ç”ŸæˆSEOéªŒè¯æŠ¥å‘Š...");

    const report = {
      timestamp: new Date().toISOString(),
      baseUrl: this.baseUrl,
      validations: [],
    };

    // éªŒè¯å·¥å…·é¡µé¢
    const toolValidation = await this.validateToolPage(
      "zh",
      "symptom-assessment",
    );
    report.validations.push({
      type: "tool-page",
      locale: "zh",
      slug: "symptom-assessment",
      ...toolValidation,
    });

    // éªŒè¯æ–‡ç« é¡µé¢
    const articleValidation = await this.validateArticlePage(
      "zh",
      "pain-relief-methods",
    );
    report.validations.push({
      type: "article-page",
      locale: "zh",
      slug: "pain-relief-methods",
      ...articleValidation,
    });

    // éªŒè¯hreflangé…ç½®
    const hreflangValidation = await this.validateHreflangConfig(
      "zh",
      "/health-guide",
    );
    report.validations.push({
      type: "hreflang-config",
      locale: "zh",
      path: "/health-guide",
      ...hreflangValidation,
    });

    // ç”Ÿæˆæµ‹è¯•URL
    const testUrls = {
      toolPage: this.generateRichResultsTestUrl(
        `${this.baseUrl}/zh/interactive-tools/symptom-assessment`,
      ),
      articlePage: this.generateRichResultsTestUrl(
        `${this.baseUrl}/zh/articles/pain-relief-methods`,
      ),
      healthGuide: this.generateRichResultsTestUrl(
        `${this.baseUrl}/zh/health-guide`,
      ),
    };

    console.log("ğŸ“‹ éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ");
    console.log("ğŸ”— Google Rich Results Test URLs:");
    console.log("  å·¥å…·é¡µé¢:", testUrls.toolPage);
    console.log("  æ–‡ç« é¡µé¢:", testUrls.articlePage);
    console.log("  å¥åº·æŒ‡å—:", testUrls.healthGuide);

    return { report, testUrls };
  }
}

// å¯¼å‡ºéªŒè¯å™¨å®ä¾‹
export const structuredDataValidator = new StructuredDataValidator();
