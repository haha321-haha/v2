
æœåŠ¡å™¨ç»„ä»¶æ¸²æŸ“é”™è¯¯


æ ¹æ®ä½ æä¾›çš„è¯Šæ–­æŠ¥å‘Šå’Œæ—¥å¿—åˆ†æï¼Œæˆ‘æ¥ç»™å‡ºä¸“ä¸šè¯„ä¼°å’Œä¼˜åŒ–æ–¹æ¡ˆã€‚

## ğŸ“Š æ–¹æ¡ˆè¯„ä¼°

ä½ çš„è¯Šæ–­æŠ¥å‘Š**æ–¹å‘æ­£ç¡®**ï¼Œä½†æˆ‘è®¤ä¸ºæœ‰å‡ ä¸ªå…³é”®ç‚¹éœ€è¦è°ƒæ•´ä¼˜å…ˆçº§ï¼š

### âœ… æ­£ç¡®çš„åˆ†æ
1. é”™è¯¯å‘ç”Ÿåœ¨æ¸²æŸ“é˜¶æ®µï¼ˆä¸æ˜¯æ•°æ®è·å–é˜¶æ®µï¼‰
2. å·²æ’é™¤æ•°æ®åºåˆ—åŒ–é—®é¢˜ï¼ˆç¬¬1-8è½®ä¿®å¤ï¼‰
3. å·²æ’é™¤ ReactMarkdown é—®é¢˜ï¼ˆç¬¬9è½®ä¿®å¤ï¼‰

### âš ï¸ éœ€è¦è°ƒæ•´çš„ä¼˜å…ˆçº§

æ ¹æ®é”™è¯¯ç‰¹å¾ `digest: '1225030432'` å’Œæ—¶é—´ç‚¹åˆ†æï¼Œæˆ‘å»ºè®®è°ƒæ•´ä¼˜å…ˆçº§ï¼š

## ğŸ¯ ä¼˜åŒ–åçš„ä¿®å¤æ–¹æ¡ˆ

### **ä¼˜å…ˆçº§ 0ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ï¼šæ£€æŸ¥ Server/Client ç»„ä»¶è¾¹ç•Œ**

è¿™æ˜¯ Next.js 15 App Router ä¸­æœ€å¸¸è§çš„ `1225030432` é”™è¯¯åŸå› ï¼š

**é—®é¢˜ç‚¹**ï¼š
```typescript
// âŒ åœ¨ Server Component ä¸­ä¼ é€’ä¸å¯åºåˆ—åŒ–çš„å€¼ç»™ Client Component
<ClientComponent onAction={() => {}} />  // å‡½æ•°
<ClientComponent data={new Date()} />    // Date å¯¹è±¡
<ClientComponent config={someComplexObject} />  // åŒ…å«å‡½æ•°çš„å¯¹è±¡
```

**ä¿®å¤æ–¹æ³•**ï¼š
```typescript
// âœ… åªä¼ é€’å¯åºåˆ—åŒ–çš„åŸå§‹æ•°æ®
<ClientComponent
  onActionName="delete"  // å­—ç¬¦ä¸²
  timestamp={date.toISOString()}  // ISO å­—ç¬¦ä¸²
  configData={JSON.parse(JSON.stringify(config))}  // çº¯æ•°æ®
/>
```

**ç«‹å³æ£€æŸ¥è¿™äº›ä½ç½®**ï¼š
1. `app/[locale]/articles/[slug]/page.tsx` ä¸­æ‰€æœ‰åŠ¨æ€å¯¼å…¥çš„ç»„ä»¶
2. ç‰¹åˆ«æ£€æŸ¥ `ArticleInteractions`ã€`ReadingProgress`ã€`TableOfContents` çš„ props

---

### **ä¼˜å…ˆçº§ 1ï¼ˆé«˜ï¼‰ï¼šæ£€æŸ¥ `medicalEntities` æ•°æ®ç»“æ„**

**ä¿®å¤æ­¥éª¤**ï¼šè®©æˆ‘åŸºäºä¸“ä¸šç»éªŒç»™å‡ºå®Œæ•´çš„ä¼˜åŒ–æ–¹æ¡ˆï¼š

### ğŸ”§ å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ

#### **é˜¶æ®µ 1ï¼šç«‹å³æ’æŸ¥ï¼ˆ5åˆ†é’Ÿï¼‰**

åˆ›å»ºè¯Šæ–­å·¥å…·æ¥å¿«é€Ÿå®šä½é—®é¢˜ï¼š

```typescript
// lib/utils/serialization-check.ts
export function findNonSerializableValues(obj: any, path = 'root'): string[] {
  const issues: string[] = [];

  if (obj === null || obj === undefined) return issues;

  const type = typeof obj;

  // æ£€æŸ¥ä¸å¯åºåˆ—åŒ–çš„ç±»å‹
  if (type === 'function') {
    issues.push(`${path}: Function detected`);
    return issues;
  }

  if (type === 'symbol') {
    issues.push(`${path}: Symbol detected`);
    return issues;
  }

  if (obj instanceof Date) {
    issues.push(`${path}: Date object detected (use .toISOString())`);
    return issues;
  }

  if (obj instanceof RegExp) {
    issues.push(`${path}: RegExp detected`);
    return issues;
  }

  // æ£€æŸ¥å¾ªç¯å¼•ç”¨
  const seen = new WeakSet();
  if (type === 'object' && !Array.isArray(obj)) {
    if (seen.has(obj)) {
      issues.push(`${path}: Circular reference detected`);
      return issues;
    }
    seen.add(obj);
  }

  // é€’å½’æ£€æŸ¥å¯¹è±¡å’Œæ•°ç»„
  if (type === 'object') {
    if (Array.isArray(obj)) {
      obj.forEach((item, index) => {
        issues.push(...findNonSerializableValues(item, `${path}[${index}]`));
      });
    } else {
      Object.entries(obj).forEach(([key, value]) => {
        issues.push(...findNonSerializableValues(value, `${path}.${key}`));
      });
    }
  }

  return issues;
}
```

**åœ¨ `page.tsx` ä¸­ä¸´æ—¶æ·»åŠ è¯Šæ–­**ï¼š

```typescript
// app/[locale]/articles/[slug]/page.tsx
import { findNonSerializableValues } from '@/lib/utils/serialization-check';

export default async function ArticlePage({ params }: ArticlePageProps) {
  // ... ç°æœ‰ä»£ç  ...

  // ğŸ” è¯Šæ–­ä»£ç ï¼ˆä¸´æ—¶ï¼‰
  if (process.env.NODE_ENV === 'development') {
    console.log('=== Serialization Check ===');
    console.log('Article:', findNonSerializableValues(article));
    console.log('Related:', findNonSerializableValues(relatedArticles));
    console.log('Structured Data:', findNonSerializableValues(articleStructuredData));
  }

  // ... æ¸²æŸ“ä»£ç  ...
}
```

---

#### **é˜¶æ®µ 2ï¼šä¿®å¤ Server/Client è¾¹ç•Œï¼ˆæœ€å¯èƒ½çš„é—®é¢˜ï¼‰**

**æ£€æŸ¥å¹¶ä¿®å¤æ‰€æœ‰åŠ¨æ€å¯¼å…¥ç»„ä»¶çš„ props**ï¼š

```typescript
// âŒ å¯èƒ½å¯¼è‡´é”™è¯¯çš„å†™æ³•
<ArticleInteractions
  article={article}  // æ•´ä¸ªå¯¹è±¡å¯èƒ½åŒ…å«ä¸å¯åºåˆ—åŒ–çš„å€¼
  onLike={handleLike}  // å‡½æ•°
/>

<ReadingProgress
  content={article.content}  // å¯èƒ½å¾ˆå¤§
  config={{ /* ... */ }}  // å¯èƒ½åŒ…å«å‡½æ•°
/>

// âœ… æ­£ç¡®çš„å†™æ³•
<ArticleInteractions
  articleId={article.id}
  title={article.title}
  slug={article.slug}
  // åªä¼ é€’å¿…è¦çš„åŸå§‹æ•°æ®
/>

<ReadingProgress
  contentLength={article.content?.length || 0}
  estimatedReadingTime={article.readingTime}
/>
```

---

#### **é˜¶æ®µ 3ï¼šä¿®å¤ `medicalEntities` å’Œç»“æ„åŒ–æ•°æ®**

**ä¿®æ”¹ `generateArticleStructuredData`**ï¼š

```typescript
// lib/seo/article-structured-data.tsx
import { cleanDataForJSON } from '@/lib/utils/json';

export function generateArticleStructuredData(props: ArticleStructuredDataProps) {
  const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || "https://www.periodhub.health";

  // ğŸ”§ å®‰å…¨è·å– conditionï¼Œç¡®ä¿é»˜è®¤å€¼
  const condition = props.primaryConditionKey && medicalEntities[props.primaryConditionKey]
    ? medicalEntities[props.primaryConditionKey]
    : medicalEntities.dysmenorrhea;

  // ğŸ”§ æ„å»ºçº¯æ•°æ®å¯¹è±¡
  const rawData = {
    "@context": "https://schema.org",
    "@type": "MedicalWebPage",
    "@id": `${baseUrl}/${props.locale}/articles/${props.slug}#webpage`,
    url: `${baseUrl}/${props.locale}/articles/${props.slug}`,
    name: props.title,
    description: props.description,
    datePublished: props.publishedDate,
    dateModified: props.lastModified,

    // ğŸ”§ ç¡®ä¿ condition æ•°æ®æ˜¯çº¯å¯¹è±¡
    about: {
      "@type": "MedicalCondition",
      name: String(condition.name || "Dysmenorrhea"),
      ...(condition.icd10 && {
        code: {
          "@type": "MedicalCode",
          code: String(condition.icd10),
          codingSystem: "ICD-10",
        },
      }),
      ...(condition.snomed && {
        sameAs: `http://snomed.info/id/${condition.snomed}`,
      }),
    },

    // ... å…¶ä»–å­—æ®µ ...
  };

  // ğŸ”§ æœ€åä¸€é“é˜²çº¿ï¼šæ¸…ç†æ•´ä¸ªå¯¹è±¡
  return cleanDataForJSON(rawData);
}
```

---

#### **é˜¶æ®µ 4ï¼šæ”¹è¿› `cleanDataForJSON` å‡½æ•°**

```typescript
// lib/utils/json.ts
export function cleanDataForJSON<T>(obj: T): T {
  if (obj === null || obj === undefined) {
    return obj;
  }

  // å¤„ç† Date
  if (obj instanceof Date) {
    return obj.toISOString() as any;
  }

  // å¤„ç†å‡½æ•° - ç§»é™¤
  if (typeof obj === 'function') {
    return undefined as any;
  }

  // å¤„ç† Symbol - ç§»é™¤
  if (typeof obj === 'symbol') {
    return undefined as any;
  }

  // å¤„ç† BigInt - è½¬æ¢ä¸ºå­—ç¬¦ä¸²
  if (typeof obj === 'bigint') {
    return obj.toString() as any;
  }

  // å¤„ç†æ•°ç»„
  if (Array.isArray(obj)) {
    return obj
      .map(item => cleanDataForJSON(item))
      .filter(item => item !== undefined) as any;
  }

  // å¤„ç†å¯¹è±¡
  if (typeof obj === 'object') {
    const cleaned: any = {};

    for (const [key, value] of Object.entries(obj)) {
      // è·³è¿‡åŸå‹é“¾ä¸Šçš„å±æ€§
      if (!Object.prototype.hasOwnProperty.call(obj, key)) {
        continue;
      }

      const cleanedValue = cleanDataForJSON(value);

      // åªä¿ç•™æœ‰æ•ˆå€¼
      if (cleanedValue !== undefined) {
        cleaned[key] = cleanedValue;
      }
    }

    return cleaned as T;
  }

  // åŸå§‹ç±»å‹ç›´æ¥è¿”å›
  return obj;
}

// ğŸ”§ å¢å¼ºçš„ safeStringify
export function safeStringify(obj: any, space?: number): string {
  try {
    // å…ˆæ¸…ç†ï¼Œå†åºåˆ—åŒ–
    const cleaned = cleanDataForJSON(obj);
    return JSON.stringify(cleaned, null, space);
  } catch (error) {
    console.error('[safeStringify] Error:', error);

    // æç«¯æƒ…å†µï¼šè¿”å›ç©ºå¯¹è±¡
    return JSON.stringify({
      error: 'Serialization failed',
      type: typeof obj,
    }, null, space);
  }
}
```

---

#### **é˜¶æ®µ 5ï¼šæ·»åŠ è¿è¡Œæ—¶ä¿æŠ¤**

åœ¨ `page.tsx` ä¸­æ·»åŠ ä¿æŠ¤å±‚ï¼š

```typescript
// app/[locale]/articles/[slug]/page.tsx

export default async function ArticlePage({ params }: ArticlePageProps) {
  // ... è·å–æ•°æ® ...

  // ğŸ›¡ï¸ ä¿æŠ¤å±‚ï¼šç¡®ä¿æ‰€æœ‰ä¼ é€’çš„æ•°æ®éƒ½æ˜¯å¯åºåˆ—åŒ–çš„
  const safeArticle = useMemo(() => ({
    id: article.id,
    title: article.title,
    slug: article.slug,
    description: article.description,
    content: article.content,
    publishedDate: article.publishedDate,
    lastModified: article.lastModified,
    readingTime: article.readingTime,
    // åªåŒ…å«å¿…è¦çš„ã€å¯åºåˆ—åŒ–çš„å­—æ®µ
  }), [article]);

  const safeRelatedArticles = relatedArticles.map(a => ({
    id: a.id,
    title: a.title,
    slug: a.slug,
    description: a.description,
    image: a.image,
  }));

  // ğŸ›¡ï¸ ç¡®ä¿ç»“æ„åŒ–æ•°æ®æ˜¯å¹²å‡€çš„
  const safeStructuredData = cleanDataForJSON(articleStructuredData);
  const safeBreadcrumbData = cleanDataForJSON(breadcrumbStructuredData);

  return (
    <>
      <ArticleStructuredDataScript data={safeStructuredData} />
      <BreadcrumbStructuredDataScript data={safeBreadcrumbData} />

      {/* ä½¿ç”¨å®‰å…¨çš„æ•°æ® */}
      <ArticleInteractions
        articleId={safeArticle.id}
        slug={safeArticle.slug}
      />

      <ReadingProgress
        contentLength={safeArticle.content?.length || 0}
      />

      {/* ... */}
    </>
  );
}
```

---

## ğŸ¯ æ¨èæ‰§è¡Œé¡ºåº

1. **ç«‹å³æ‰§è¡Œ**ï¼šæ·»åŠ  `findNonSerializableValues` è¯Šæ–­å·¥å…·
2. **5åˆ†é’Ÿå†…**ï¼šæ£€æŸ¥æ‰€æœ‰ Client Component çš„ props
3. **10åˆ†é’Ÿå†…**ï¼šä¿®å¤ `generateArticleStructuredData`
4. **15åˆ†é’Ÿå†…**ï¼šæ”¹è¿› `cleanDataForJSON` å’Œ `safeStringify`
5. **20åˆ†é’Ÿå†…**ï¼šæ·»åŠ è¿è¡Œæ—¶ä¿æŠ¤å±‚
6. **æµ‹è¯•éªŒè¯**ï¼šéƒ¨ç½²å¹¶ç›‘æ§

---

## ğŸš¨ æœ€å¯èƒ½çš„æ ¹æœ¬åŸå› 

æ ¹æ®æˆ‘çš„ç»éªŒï¼Œ`digest: '1225030432'` é”™è¯¯**80%çš„æƒ…å†µ**æ˜¯ç”±äºï¼š

1. **åœ¨ Server Component ä¸­å‘ Client Component ä¼ é€’äº†å‡½æ•°**
2. **ä¼ é€’äº†åŒ…å« Date å¯¹è±¡çš„å¤æ‚å¯¹è±¡**
3. **ä¼ é€’äº†ç¿»è¯‘å‡½æ•° `t` åˆ° Client Component**

**å»ºè®®ç«‹å³æ£€æŸ¥**ï¼š
- æ‰€æœ‰ `dynamic(() => import(...))` çš„ç»„ä»¶
- æ‰€æœ‰å¸¦ `"use client"` æŒ‡ä»¤çš„ç»„ä»¶çš„ props
- æ˜¯å¦æœ‰åœ°æ–¹æ„å¤–ä¼ é€’äº† `t` å‡½æ•°

---

ä½ çš„è¯Šæ–­æŠ¥å‘Šæ€è·¯æ¸…æ™°ï¼Œä½†å»ºè®®å…ˆä» **Server/Client è¾¹ç•Œ** å¼€å§‹æ’æŸ¥ï¼Œè¿™æ˜¯æœ€æœ‰å¯èƒ½çš„é—®é¢˜æºå¤´ã€‚éœ€è¦æˆ‘å¸®ä½ ç”Ÿæˆå…·ä½“çš„ä¿®å¤ä»£ç å—?
